let marker = null;
    let lastCoordsText = "";
    let lastLatLng = null;

    const statusEl = document.getElementById("status");
    const coordsEl  = document.getElementById("coordsValue");
    const btnCopy   = document.getElementById("btnCopy");
    const btnClear  = document.getElementById("btnClear");
    const btnLocate = document.getElementById("btnLocate");
    const btnGmaps  = document.getElementById("btnGmaps");

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function setPoint(latlng) {
      const lat = latlng.lat.toFixed(6);
      const lng = latlng.lng.toFixed(6);
      lastCoordsText = ${lat}, ${lng};
      lastLatLng = { lat, lng };

      if (marker) map.removeLayer(marker);
      marker = L.marker(latlng).addTo(map);

      coordsEl.textContent = lastCoordsText;

      btnCopy.disabled = false;
      btnClear.disabled = false;
      btnGmaps.disabled = false;

      marker.bindPopup(`
        <strong>ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ âœ…</strong><br/>
        <span style="font-family:monospace;direction:ltr;display:inline-block;margin-top:6px;">
          ${lastCoordsText}
        </span>
        <div style="margin-top:8px;font-size:12px;opacity:.85;">
          ØªÙ‚Ø¯Ø±ÙŠÙ† ØªÙ†Ø³Ø®ÙŠÙ† Ù…Ù† Ø§Ù„Ø²Ø± ÙÙˆÙ‚ Ø£Ùˆ Ù…Ù† Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø£Ø³ÙÙ„.
        </div>
      `).openPopup();

      setStatus("ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ âœ… Ø§Ù†Ø³Ø®ÙŠ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª.");
    }

    // Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    map.on("click", function (e) {
      setPoint(e.latlng);
    });

    // Ø²Ø± Ø§Ù„Ù†Ø³Ø® (Ù…Ø¹ Plan B Ù„Ùˆ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ Clipboard)
    btnCopy.addEventListener("click", async () => {
      if (!lastCoordsText) return;

      try {
        await navigator.clipboard.writeText(lastCoordsText);
        setStatus("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…");
      } catch (err) {
        // Plan B: ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø´Ø§Ù† ÙŠÙ†Ø³Ø®Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§
        setStatus("Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø§ Ø§Ø´ØªØºÙ„ Ù‡Ù†Ø§ â€” Ø§Ù†Ø³Ø®ÙŠ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ù…Ø±Ø¨Ø¹ ğŸ‘‡");
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ
        const range = document.createRange();
        range.selectNodeContents(coordsEl);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    });

    // ÙØªØ­ ÙÙŠ Google Maps
    btnGmaps.addEventListener("click", () => {
      if (!lastLatLng) return;
      const url = https://www.google.com/maps?q=${lastLatLng.lat},${lastLatLng.lng};
      window.open(url, "_blank");
    });

    // Ù…Ø³Ø­ Ø§Ù„Ø¯Ø¨ÙˆØ³
    btnClear.addEventListener("click", () => {
      if (marker) map.removeLayer(marker);
      marker = null;
      lastCoordsText = "";
      lastLatLng = null;
      coordsEl.textContent = "â€”";
      btnCopy.disabled = true;
      btnClear.disabled = true;
      btnGmaps.disabled = true;
      setStatus("ØªÙ… Ø§Ù„Ù…Ø³Ø­. Ø§Ø¶ØºØ·ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø¬Ø¯ÙŠØ¯.");
    });

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (GPS)
    btnLocate.addEventListener("click", () => {
      if (!navigator.geolocation) {
        setStatus("Ø¬Ù‡Ø§Ø²Ùƒ Ù…Ø§ ÙŠØ¯Ø¹Ù… GPS.");
        return;
      }

      setStatus("Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒâ€¦ Ø§Ù†ØªØ¸Ø±ÙŠ Ø´ÙˆÙŠ â³");

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const latlng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          map.setView(latlng, 15);
          setPoint(latlng);
          setStatus("Ù‡Ø°Ø§ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ âœ… Ø¥Ø°Ø§ Ù…Ùˆ Ø¯Ù‚ÙŠÙ‚ØŒ Ø¹Ø¯Ù‘Ù„ÙŠ Ø¨Ø§Ù„Ø¯Ø¨ÙˆØ³.");
        },
        (err) => {
          setStatus("Ù…Ø§ Ù‚Ø¯Ø±Ù†Ø§ Ù†Ø¬ÙŠØ¨ Ù…ÙˆÙ‚Ø¹Ùƒ. ÙØ¹Ù‘Ù„ÙŠ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹/Location Ø«Ù… Ø¬Ø±Ù‘Ø¨ÙŠ.");
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    });
  </script>

</body>
</html>
