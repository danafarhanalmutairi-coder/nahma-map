const coordsEl = $("coordsValue");
  const btnCopy  = $("btnCopy");
  const btnClear = $("btnClear");
  const btnOpen  = $("btnOpen");
  const toastEl  = $("toast");

  function setStatus(text) {
    statusEl.textContent = text;
  }

  function toast(msg, type="ok") {
    toastEl.className = "toast show " + (type === "warn" ? "warn" : "ok");
    toastEl.innerHTML = msg;
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(() => toastEl.classList.remove("show"), 1800);
  }

  // ===== Map =====
  const map = L.map("map", { zoomControl: true }).setView([26.4207, 50.0888], 12);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "Â© OpenStreetMap"
  }).addTo(map);

  let marker = null;
  let lastLat = null;
  let lastLng = null;
  let lastText = "";

  function setPoint(latlng) {
    if (marker) map.removeLayer(marker);
    marker = L.marker(latlng).addTo(map);

    lastLat = latlng.lat;
    lastLng = latlng.lng;

    const lat = lastLat.toFixed(6);
    const lng = lastLng.toFixed(6);
    lastText = ${lat}, ${lng};

    coordsEl.textContent = lastText;
    setStatus("ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ âœ“");

    btnCopy.disabled = false;
    btnClear.disabled = false;
    btnOpen.disabled = false;

    marker.bindPopup(`<b>ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯</b><br><span style="direction:ltr;display:inline-block">${lastText}</span>`).openPopup();
  }

  map.on("click", (e) => {
    setPoint(e.latlng);
  });

  // ===== Buttons =====
  btnCopy.addEventListener("click", async () => {
    if (!lastText) return;
    try{
      await navigator.clipboard.writeText(lastText);
      toast(`âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: <span class="muted" style="direction:ltr;display:inline-block">${lastText}</span>`);
      setStatus("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ“");
    }catch(err){
      // fallback: select text
      const range = document.createRange();
      range.selectNodeContents(coordsEl);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      toast("âš ï¸ Ù…Ø§ Ù‚Ø¯Ø±Øª Ø£Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. Ø§Ù†Ø³Ø®ÙŠÙ‡Ø§ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙÙˆÙ‚.", "warn");
      setStatus("Ø§Ù†Ø³Ø®ÙŠ ÙŠØ¯ÙˆÙŠÙ‹Ø§");
    }
  });

  btnClear.addEventListener("click", () => {
    if (marker) map.removeLayer(marker);
    marker = null;
    lastLat = lastLng = null;
    lastText = "";
    coordsEl.textContent = "â€”";
    btnCopy.disabled = true;
    btnClear.disabled = true;
    btnOpen.disabled = true;
    setStatus("ØªÙ… Ø§Ù„Ù…Ø³Ø­");
    toast("ðŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ¯");
  });

  btnOpen.addEventListener("click", () => {
    if (!lastText) return;
    const url = https://www.openstreetmap.org/?mlat=${lastLat}&mlon=${lastLng}#map=18/${lastLat}/${lastLng};
    window.open(url, "_blank");
  });
</script>

</body>
</html>
